import * as SidebarCart from './sidebar-cart.js';
// JavaScript for handling the admin panel product form submission
document.getElementById('productForm').addEventListener('submit', async function (event) {
    event.preventDefault();

    const product = {
        id: null, // ID will be generated by the server
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        price: document.getElementById('price').value, // string for BigDecimal
        stock: parseInt(document.getElementById('stock').value, 10)
    };

    const messageDiv = document.getElementById('message');

    try {
        const response = await fetch('/api/admin/newproduct', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(product)
        });

        if (response.ok) {
            const newProduct = await response.json();
            createProductRow(newProduct);
            messageDiv.innerText = 'Product added with id ' + newProduct.id;
            messageDiv.className = 'alert alert-success';
            document.getElementById('productForm').reset();
        } else {
            const error = await response.text();
            messageDiv.innerText = 'Error: ' + error;
            messageDiv.className = 'alert alert-error';
        }
    } catch (err) {
        messageDiv.innerText = 'Network error: ' + err.message;
        messageDiv.className = 'alert alert-error';
    }
});

// Cart showing
SidebarCart.loadAndShowCart();

//Products

async function loadAndShowProducts() {
    try {
        const response = await fetch('/api/products/summaries');
        const items = await response.json();

        const container = document.getElementById('productList');
        container.innerHTML = ''; // clear old

        items.forEach(item => {
            createProductSummaryRow(item);
        });
    } catch (err) {
        console.error('Failed to load products', err);
    }
}

//TODO refactor to use createProductRow
function createProductSummaryRow(item) {
    const container = document.getElementById('productList');
    const row = document.createElement('div');
    row.classList.add('product-row');
    row.innerHTML = `
    <span class="product-name">${item.name}</span>
    <span class="product-price">${item.price}z≈Ç</span>
    <span class="product-qty">x${item.stock}szt.</span>
    `;
    const button = document.createElement('button');
    button.classList.add('add-to-cart-btn');
    button.textContent = '+';

    button.addEventListener('click', () => {
        SidebarCart.addProductByIdToCart(item.id);
    });

    row.appendChild(button);
    container.appendChild(row);
}

loadAndShowProducts();

// --- Search logic ---
document.getElementById('searchimageButton').addEventListener('click', async () => {
    const keyword = document.getElementById('searchimageKeyword').value.trim();
    if (!keyword) return;

    try {
        const response = await fetch(`/api/products/summaries-no-pic/search?keyword=${encodeURIComponent(keyword)}`);
        if (!response.ok) {
            throw new Error('Failed to fetch products');
        }
        const products = await response.json();
        renderSearchResults(products);
    } catch (error) {
        console.error('Search error:', error);
        document.getElementById('searchResults').innerText = 'Error fetching products.';
    }
});

function renderSearchResults(products) {
    const resultsDiv = document.getElementById('searchimageResults');
    resultsDiv.innerHTML = '';

    if (!products || products.length === 0) {
        resultsDiv.innerText = 'No products found.';
        return;
    }

    products.forEach(product => {
        resultsDiv.appendChild(createProductRow(product));
    });

}

function createProductRow(product) {
    const row = document.createElement('div');
    row.className = 'product-row';

    // Product name (link)
    const nameLink = document.createElement('a');
    nameLink.href = `/admin/edit-product/${product.publicId}`;
    nameLink.innerText = product.name;
    nameLink.target = '_blank';

    // Price
    const priceSpan = document.createElement('span');
    priceSpan.className = 'product-cell';
    priceSpan.innerText = `Price: $${product.price}`;

    // Stock
    const stockSpan = document.createElement('span');
    stockSpan.className = 'product-cell';
    stockSpan.innerText = `Stock: ${product.stock}`;

    row.appendChild(nameLink);
    row.appendChild(priceSpan);
    row.appendChild(stockSpan);

    return row;
}

// Shipments to pack

async function loadAndShowShipmentsToPack() {
    const messageDiv = document.getElementById('messageShipments');
    try {
        const response = await fetch('/api/packer/to-pack');
        if (!response.ok) {
            throw new Error('Failed to fetch shipments' + await response.text());
        }
        const shipments = await response.json();
        renderShipmentsToPack(shipments);
    } catch (error) {
        console.error('Error loading shipments:', error);
        messageDiv.innerText = 'Error fetching shipments: ' + error.message;
        messageDiv.className = 'alert alert-error';
    }
}

function renderShipmentsToPack(shipments) {
    const shipmentListDiv = document.getElementById('shipmentList');
    shipmentListDiv.innerHTML = JSON.stringify(shipments, null, 2); // Simple rendering for now
}

document.addEventListener('DOMContentLoaded', () => {
    loadAndShowShipmentsToPack();
});